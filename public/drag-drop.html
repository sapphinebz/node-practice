<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <img
      data-drag
      src="https://assets.pokemon.com/assets/cms2/img/pokedex/detail/001.png"
      alt="Bulbasaur"
    />
    <img
      data-drag
      src="https://assets.pokemon.com/assets/cms2/img/pokedex/detail/004.png"
      alt="Charmander"
    />
    <img
      data-drag
      src="https://assets.pokemon.com/assets/cms2/img/pokedex/detail/007.png"
      alt="Squirtle"
    />
    <script src="https://unpkg.com/rxjs@^7/dist/bundles/rxjs.umd.min.js"></script>
    <script>
      const {
        from,
        mergeMap,
        fromEvent,
        exhaustMap,
        takeUntil,
        tap,
        map,
        merge,
        filter,
        webSocket: { webSocket },
      } = rxjs;

      const webSocketSubject = webSocket({
        url: "ws://localhost:4000",
        deserializer: (serverMessage) => {
          return JSON.parse(serverMessage.data);
        },
      });

      const elementList = document.querySelectorAll("[data-drag]");

      from(elementList.values())
        .pipe(
          mergeMap((element) => {
            element.style.cursor = "grab";
            let translateX = 0;
            let translateY = 0;
            const movedown$ = fromEvent(element, "mousedown").pipe(
              exhaustMap((downEvent) => {
                downEvent.preventDefault();
                const mouseup$ = fromEvent(document, "mouseup");
                return fromEvent(document, "mousemove").pipe(
                  tap((moveEvent) => {
                    const dx = moveEvent.x - downEvent.x;
                    const dy = moveEvent.y - downEvent.y;
                    const rx = translateX + dx;
                    const ry = translateY + dy;
                    element.style.transform = `translate(${rx}px, ${ry}px)`;

                    webSocketSubject.next({
                      alt: element.getAttribute("alt"),
                      x: rx,
                      y: ry,
                    });
                  }),
                  takeUntil(
                    mouseup$.pipe(
                      tap((upEvent) => {
                        const dx = upEvent.x - downEvent.x;
                        const dy = upEvent.y - downEvent.y;

                        translateX = translateX + dx;
                        translateY = translateY + dy;
                      })
                    )
                  )
                );
              })
            );

            const updateFromServer$ = webSocketSubject.pipe(
              map((msg) => msg[element.alt]),
              filter((state) => {
                return state !== undefined;
              }),
              tap((state) => {
                const { x, y } = JSON.parse(state);

                translateX = x;
                translateY = y;
                element.style.transform = `translate(${x}px, ${y}px)`;
              })
            );

            return merge(movedown$, updateFromServer$);
          })
        )
        .subscribe();
    </script>
  </body>
</html>
