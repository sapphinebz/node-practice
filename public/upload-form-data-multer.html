<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h3>upload files</h3>
    <script src="https://unpkg.com/rxjs@^7/dist/bundles/rxjs.umd.min.js"></script>
    <input data-upload-files id="files" type="file" multiple />
    <div data-selected></div>
    <div data-upload-button style="display: none">
      <button>upload</button>
    </div>
    <!-- let formData = new FormData()

    formData.append("file", selectedFiles[0]) -->

    <!-- headers: {
        "Content-Type": "multipart/form-data",
      }, -->
    <script>
      const {
        fromEvent,
        EMPTY,
        catchError,
        tap,
        fetch: { fromFetch },
      } = rxjs;
      const { switchMap } = rxjs.operators;
      const uploadFilesEl = document.querySelector("[data-upload-files]");
      const selectedEl = document.querySelector("[data-selected]");
      const uploadButtonEl = document.querySelector("[data-upload-button]");
      fromEvent(uploadFilesEl, "change")
        .pipe(
          switchMap((event) => {
            const files = uploadFilesEl.files;
            const filesArray = Array.from(files);
            const selectedName = filesArray.reduce((path, file) => {
              path += `<div>${file.name}</div>`;
              return path;
            }, "");
            selectedEl.innerHTML = `${selectedName}`;
            if (files.length > 0) {
              uploadButtonEl.style.display = "block";
              return fromEvent(uploadButtonEl, "click").pipe(
                switchMap(() => {
                  const formData = new FormData();
                  filesArray.forEach((file) => {
                    formData.append("files", file);
                  });

                  return fromFetch("/upload", {
                    method: "POST",
                    body: formData,
                    // headers: {
                    //   "Content-Type": "multipart/form-data",
                    // },
                  }).pipe(
                    tap(() => {
                      uploadFilesEl.value = "";
                      selectedEl.innerHTML = "";
                      uploadButtonEl.style.display = "none";
                    }),
                    catchError((err) => {
                      return EMPTY;
                    })
                  );
                })
              );
            }
            return EMPTY;
          })
        )
        .subscribe(console.log);
    </script>
  </body>
</html>
