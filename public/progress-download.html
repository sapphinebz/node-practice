<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Progress Download</title>
  </head>
  <body>
    <div>
      <div>
        <h3>fetch API</h3>
        <button data-fetchEl>fetch</button>
        <div data-content></div>
      </div>
      <div>
        <h3>download PDF</h3>
        <button data-downloadEl>download</button>
      </div>
      <div>
        <h3>XHR download stream</h3>
        <button data-downloadStreamEl>download</button>
        <span data-percent></span>
      </div>
    </div>
    <script src="https://unpkg.com/rxjs@^7/dist/bundles/rxjs.umd.min.js"></script>
    <script>
      const {
        fromEvent,
        exhaustMap,
        tap,
        Observable,
        takeLast,
        catchError,
        EMPTY,
        fetch: { fromFetch },
      } = rxjs;

      const downloadStreamEl = document.querySelector(
        "[data-downloadStreamEl]"
      );

      const percentEl = document.querySelector("[data-percent]");
      fromEvent(downloadStreamEl, "click")
        .pipe(
          exhaustMap(() => {
            percentEl.innerText = `pending...`;
            return XMLHttpRequestProgressDownload(
              `http://localhost:4200/pdf`
            ).pipe(
              catchError((err) => {
                alert(err);
                return EMPTY;
              }),
              tap((res) => {
                percentEl.innerText = `${res.percent}%`;
              }),
              takeLast(1),
              tap((res) => {
                const blob = new Blob([res.data], {
                  type: "application/pdf",
                });
                clickAnchorWithBlob(blob, "rxjs.pdf");
              })
            );
          })
        )
        .subscribe();

      const downloadEl = document.querySelector("[data-downloadEl]");
      fromEvent(downloadEl, "click")
        .pipe(
          exhaustMap(() => {
            return fromFetch(`http://localhost:4200/pdf`, {
              method: "GET",
              headers: {
                "Access-Control-Allow-Origin": "http://localhost:3000/",
              },
              selector: (res) => res.blob(),
            }).pipe(
              catchError((err) => {
                alert(err);
                return EMPTY;
              }),
              tap((blob) => {
                clickAnchorWithBlob(blob, "rxjs.pdf");
              })
            );
          })
        )
        .subscribe();

      const fetchEl = document.querySelector("[data-fetchEl]");
      fromEvent(fetchEl, "click")
        .pipe(
          exhaustMap(() => {
            return fromFetch(`http://localhost:4200/data`, {
              method: "GET",
              headers: {
                "Access-Control-Allow-Origin": "http://localhost:3000/",
              },
              selector: (res) => res.json(),
            }).pipe(
              catchError((err) => {
                alert(err);
                return EMPTY;
              })
            );
          })
        )
        .subscribe(({ results }) => {
          const contentEl = document.querySelector("[data-content]");
          contentEl.innerHTML = ``;
          for (const result of results) {
            const div = document.createElement("div");
            div.innerText = JSON.stringify(result);
            contentEl.appendChild(div);
          }
        });

      function XMLHttpRequestProgressDownload(url) {
        return new Observable((subscriber) => {
          let xhr = new XMLHttpRequest();
          let progress = { data: null, percent: 0 };

          xhr.open("GET", url);
          xhr.responseType = "blob";
          xhr.setRequestHeader(
            "Access-Control-Allow-Origin",
            "http://localhost:3000/"
          );

          xhr.onprogress = (event) => {
            progress = {
              ...progress,
              percent: (event.loaded / event.total) * 100,
            };
            subscriber.next(progress);
          };

          xhr.onload = () => {
            if (xhr.status != 200) {
              subscriber.error({
                status: xhr.status,
                statusText: xhr.statusText,
              });
            } else {
              subscriber.next({ ...progress, data: xhr.response });
              subscriber.complete();
            }
          };

          xhr.send();

          return {
            unsubscribe: () => {
              xhr.abort();
            },
          };
        });
      }

      function clickAnchorWithBlob(blob, fileName) {
        const blobUrl = URL.createObjectURL(blob);
        const anchor = document.createElement("a");
        document.body.append(anchor);
        anchor.href = blobUrl;
        anchor.download = fileName;
        anchor.click();

        anchor.remove();

        URL.revokeObjectURL(blobUrl);
      }
    </script>
  </body>
</html>
